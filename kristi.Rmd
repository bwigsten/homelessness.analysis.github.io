---
title: "Shiny Dashboard"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(tidyverse)
library(forcats)
library(viridis)
library(plotly)
```

```{r}
homelessness = 
  read.csv("./data/us_homelessness_07_18.csv")

# calculating total percentage per state by year
count_total_state = 
  homelessness %>% 
  mutate(state = fct_explicit_na(state)) %>% 
  group_by(year, state) %>% 
  mutate(
    tot_hmls_st = sum(total_homeless),
    shel_hmls_st = sum(sheltered_homeless),
    unshel_hmls_st = sum(unsheltered_homeless),
    tot_hous_st = sum(total_households),
    shel_hous_st = sum(sheltered_households),
    unshel_hous_st = sum(unsheltered_households),
    tot_chr_st = sum(total_chronic),
    shel_chr_st = sum(sheltered_chronic),
    unshel_chr_st = sum(unsheltered_chronic),
    tot_vet_st = sum(total_veterans),
    shel_vet_st = sum(sheltered_veterans),
    unshel_vet_st = sum(unsheltered_veterans),
    tot_youth_st = sum(youth)
    ## need to do this for each variable of interest, then get breakdown of other variables based on state's overall percentage
  ) %>%
  distinct(year, state, tot_hmls_st, shel_hmls_st, unshel_hmls_st, tot_hous_st, shel_hous_st, unshel_hous_st, tot_chr_st, shel_chr_st, unshel_chr_st, tot_vet_st, shel_vet_st, unshel_vet_st, tot_youth_st) %>% 
  ungroup()
```

Column {.sidebar}
-----------------------------------------------------------------------

```{r}
years = 
  count_total_state %>% 
  distinct(year) %>% 
  pull()

variables = 
  count_total_state %>% 
  select(tot_hmls_st:tot_youth_st) %>% 
  rename(
    "Total Homeless" = tot_hmls_st,
    "Sheltered Homeless" = shel_hmls_st,
    "Unsheltered Homeless" = unshel_hmls_st,
    "Total Households" = tot_hous_st,
    "Sheltered Households" = shel_hous_st,
    "Unsheltered Households" = unshel_hous_st,
    "Total Chronic" = tot_chr_st,
    "Sheltered Chronic" = shel_chr_st,
    "Unsheltered Chronic" = unshel_chr_st,
    "Total Veterans" = tot_vet_st,
    "Sheltered Veterans" = shel_vet_st,
    "Unsheltered Veterans" = unshel_vet_st,
    "Total Youth" = tot_youth_st
  ) %>% 
  colnames()

# select years
selectInput(
  "year_choice",
  label = h3("Select year"),
  choices = years, selected = "2018"
  )

selectInput(
  "variable_type",
  label = h3("Select variable"),
  choices = variables, selected = "Total Homeless"
  )
```

Column {data-width=1000}
-----------------------------------------------------------------------

### Homelessness Distributions in the United States

```{r}
renderPlotly({
	# map plot setting
	geo1 <- list(
	scope = "usa",
	projection = list(type = "state"),
	showlakes = TRUE,
	lakecolor = toRGB("white")
	)
	
	# display value using color intensity
	merged_data %>% 
	filter(type_variable == input$variable_type, year == input$year_1) %>% 
	plot_geo(locationmode = "USA-states") %>% 
	add_trace(
		z = ~Statistics,
		locations = ~state,
		color = ~Statistics,
		colors = "Reds",
		# add text
		text = ~paste(type_variable, state_abb[state], sep = "")
		) %>%
	layout(
		geo = geo1,
		title = "US Map - State Statistics",
		legend = list(x = 100, y = 0.5)
	)
})
```


